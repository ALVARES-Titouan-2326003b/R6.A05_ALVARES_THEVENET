{% extends 'base.html.twig' %}

{% block title %}Espace Professeur - EduLearn{% endblock %}

{% block body %}
    <!-- HERO SECTION PROFESSEUR -->
    <div class="hero" style="background: linear-gradient(135deg, #10b981, #059669);">
        <div class="container">
            <h1>üéì Espace Professeur</h1>
            <p>G√©rez vos cours, uploadez des ressources et cr√©ez des QCM g√©n√©r√©s par IA</p>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number">{{ videos|length }}</div>
                    <div class="stat-label">Vid√©os en ligne</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ documents|length }}</div>
                    <div class="stat-label">Documents PDF</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ videos|length + documents|length }}</div>
                    <div class="stat-label">Ressources totales</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container my-5">
        <!-- MESSAGES FLASH -->
        {% for message in app.flashes('success') %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                ‚úÖ {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
        {% for message in app.flashes('error') %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                ‚ùå {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}

        <!-- CAROUSEL VID√âOS -->
        <div class="card mb-5">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">üìπ Vid√©os de Cours</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadVideoModal">
                            ‚ûï Upload Vid√©o
                        </button>
                        <div class="carousel-controls">
                            <button class="carousel-btn" onclick="scrollCarousel('videos-carousel', -320)">‚Üê</button>
                            <button class="carousel-btn" onclick="scrollCarousel('videos-carousel', 320)">‚Üí</button>
                        </div>
                    </div>
                </div>

                <div class="row flex-nowrap overflow-auto pb-3" id="videos-carousel" style="scroll-behavior: smooth;">
                    {% if videos is empty %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <p class="mb-0">Aucune vid√©o disponible. Uploadez votre premi√®re vid√©o ! üé¨</p>
                            </div>
                        </div>
                    {% else %}
                        {% for video in videos %}
                            <div class="col-12 col-md-6 col-lg-4 col-xl-3 mb-3" id="qcm-{{ video.id }}">
                                <div class="card h-100">
                                    <div class="carousel-item-video position-relative">
                                        üé¨
                                        <div class="position-absolute" style="width: 60px; height: 60px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--primary);">
                                            ‚ñ∂
                                        </div>
                                    </div>

                                    <div class="card-body">
                                        <h5 class="card-title fw-bold">{{ video.title }}</h5>
                                        <p class="card-text text-muted small mb-3">
                                            {{ video.description|length > 80 ? video.description|slice(0, 80) ~ '...' : video.description }}
                                        </p>

                                        <button class="btn btn-success-custom mb-2" onclick="generateQCM('video', {{ video.id }})">
                                            ü§ñ G√©n√©rer QCM
                                        </button>

                                        <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteResource({{ video.id }})">
                                            üóëÔ∏è Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- CAROUSEL DOCUMENTS -->
        <div class="card mb-5">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">üìÑ Documents de Cours</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadPdfModal">
                            ‚ûï Upload PDF
                        </button>
                        <div class="carousel-controls">
                            <button class="carousel-btn" onclick="scrollCarousel('documents-carousel', -320)">‚Üê</button>
                            <button class="carousel-btn" onclick="scrollCarousel('documents-carousel', 320)">‚Üí</button>
                        </div>
                    </div>
                </div>

                <div class="row flex-nowrap overflow-auto pb-3" id="documents-carousel" style="scroll-behavior: smooth;">
                    {% if documents is empty %}
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <p class="mb-0">Aucun document disponible. Uploadez votre premier PDF ! üìÑ</p>
                            </div>
                        </div>
                    {% else %}
                        {% for document in documents %}
                            <div class="col-12 col-md-6 col-lg-4 col-xl-3 mb-3" id="qcm-{{ document.id }}">
                                <div class="card h-100">
                                    <div class="carousel-item-document">
                                        üìë
                                    </div>

                                    <div class="card-body">
                                        <h5 class="card-title fw-bold">{{ document.title }}</h5>
                                        <p class="card-text text-muted small mb-3">
                                            {{ document.description|length > 80 ? document.description|slice(0, 80) ~ '...' : document.description }}
                                        </p>

                                        <button class="btn btn-success-custom mb-2" onclick="generateQCM('document', {{ document.id }})">
                                            ü§ñ G√©n√©rer QCM
                                        </button>

                                        <button class="btn btn-outline-danger btn-sm w-100" onclick="deleteResource({{ document.id }})">
                                            üóëÔ∏è Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL UPLOAD VID√âO -->
    <div class="modal fade" id="uploadVideoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                    <h5 class="modal-title">üìπ Upload une Vid√©o</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="{{ path('app_teacher_upload_video') }}" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="video_title" class="form-label fw-bold">Titre de la vid√©o *</label>
                            <input type="text" class="form-control" id="video_title" name="title" required placeholder="Ex: Introduction √† Symfony">
                        </div>
                        <div class="mb-3">
                            <label for="video_description" class="form-label fw-bold">Description *</label>
                            <textarea class="form-control" id="video_description" name="description" rows="3" required placeholder="D√©crivez le contenu de la vid√©o..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="video_file" class="form-label fw-bold">Fichier vid√©o *</label>
                            <input type="file" class="form-control" id="video_file" name="video_file" accept="video/*" required>
                            <div class="form-text">Formats accept√©s : MP4, AVI, MOV (max 500MB)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-success">üì§ Uploader</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL UPLOAD PDF -->
    <div class="modal fade" id="uploadPdfModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white;">
                    <h5 class="modal-title">üìÑ Upload un Document PDF</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="{{ path('app_teacher_upload_pdf') }}" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="pdf_title" class="form-label fw-bold">Titre du document *</label>
                            <input type="text" class="form-control" id="pdf_title" name="title" required placeholder="Ex: Support de cours - Doctrine ORM">
                        </div>
                        <div class="mb-3">
                            <label for="pdf_description" class="form-label fw-bold">Description *</label>
                            <textarea class="form-control" id="pdf_description" name="description" rows="3" required placeholder="D√©crivez le contenu du document..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="pdf_file" class="form-label fw-bold">Fichier PDF *</label>
                            <input type="file" class="form-control" id="pdf_file" name="pdf_file" accept=".pdf" required>
                            <div class="form-text">Format accept√© : PDF uniquement (max 50MB)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn btn-success">üì§ Uploader</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        function scrollCarousel(id, amount) {
            const carousel = document.getElementById(id);
            carousel.scrollBy({ left: amount, behavior: 'smooth' });
        }

        function generateQCM(type, id) {
            const confirmMsg = `Voulez-vous g√©n√©rer un QCM automatique pour ce ${type === 'video' ? 'vid√©o' : 'document'} ?`;

            if (confirm(confirmMsg)) {
                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '‚è≥ G√©n√©ration...';
                btn.disabled = true;

                setTimeout(() => {
                    btn.innerHTML = '‚úÖ QCM Cr√©√© !';
                    btn.classList.remove('btn-success-custom');
                    btn.classList.add('btn-success');

                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-success-custom');
                    }, 2000);

                    alert('QCM g√©n√©r√© avec succ√®s ! üéâ\n\n‚Ä¢ 10 questions cr√©√©es\n‚Ä¢ Difficult√© progressive\n‚Ä¢ Disponible pour les √©tudiants');
                }, 2000);
            }
        }

        // ‚úÖ SUPPRESSION DIRECTE - Pas de pop-ups
        async function deleteResource(id) {
            const card = document.getElementById(`qcm-${id}`);

            if (!card) return;

            // Animation imm√©diate
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '0.5';
            card.style.pointerEvents = 'none';

            try {
                const response = await fetch(`/teacher/delete/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Animation de disparition
                    card.style.transform = 'scale(0.8)';
                    card.style.opacity = '0';

                    setTimeout(() => {
                        card.remove();

                        // V√©rifier si le carrousel est vide
                        const carousel = card.closest('.row');
                        if (carousel && carousel.querySelectorAll('[id^="qcm-"]').length === 0) {
                            carousel.innerHTML = `
                                <div class="col-12">
                                    <div class="alert alert-info text-center">
                                        <p class="mb-0">Aucune ressource disponible.</p>
                                    </div>
                                </div>
                            `;
                        }
                    }, 300);
                } else {
                    // En cas d'erreur, restaurer
                    console.error('Erreur:', data.message);
                    card.style.opacity = '1';
                    card.style.pointerEvents = 'auto';
                }

            } catch (error) {
                console.error('Erreur:', error);
                // Restaurer en cas d'erreur r√©seau
                card.style.opacity = '1';
                card.style.pointerEvents = 'auto';
            }
        }
    </script>
{% endblock %}
